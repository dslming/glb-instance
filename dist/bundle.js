import*as e from"three";import{GLTFLoader as t}from"three/addons/loaders/GLTFLoader.js";import{GLTFExporter as n}from"three/addons/exporters/GLTFExporter.js";import{OrbitControls as s}from"three/addons/controls/OrbitControls.js";const r=new class{constructor(){this.dataMap=new Map}set(e,t){this.dataMap.set(e,t)}get(e){return this.dataMap.get(e)}},o=document.createElement("a");function i(e,t){!function(e,t){o.href&&URL.revokeObjectURL(o.href),o.href=URL.createObjectURL(e),o.download=t,o.dispatchEvent(new MouseEvent("click"))}(new Blob([e],{type:"application/octet-stream"}),t)}class a{constructor(){}loadFile(){return new Promise(((e,n)=>{const s=r.get("file"),o=s.name,i=new FileReader;i.addEventListener("progress",(function(e){const t="("+(n=Math.floor(e.total/1e3),new Intl.NumberFormat("en-us",{useGrouping:!0}).format(n)+" KB)");var n;const s=Math.floor(e.loaded/e.total*100)+"%";console.log("Loading",o,t,s)})),i.addEventListener("error",(e=>{console.error("Error",e),n(e)})),i.addEventListener("load",(function(n){const s=n.target.result;(new t).parse(s,"",(t=>{const n=t.scene;n.name=o,n.animations.push(...t.animations),e(n)}))}),!1),i.readAsArrayBuffer(s)}))}}class c{constructor(){}export(e){return new Promise(((t,s)=>{const r=function(e){const t=[];return e.traverse((function(e){t.push(...e.animations)})),t}(e),o=[];for(const e of r)o.push(e.clone().optimize());const a="scene.glb";(new n).parse(e,(function(e){i(e,a),t(a)}),void 0,{trs:!1,binary:!0,animations:o})}))}}class d{constructor(){this._scene=new e.Scene,this._camera=new e.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,1e5),this._camera.position.set(-100,100.5,200),this._camera.lookAt(0,.5,0),this._scene.background=new e.Color(2434341);const t=new e.HemisphereLight;this._scene.add(t);const n=new e.DirectionalLight(16777215,3);n.position.set(5,5,5),n.castShadow=!0,n.shadow.camera.zoom=2,this._scene.add(n);const r=document.querySelector(".gltf-viewer");this._renderer=new e.WebGLRenderer({antialias:!0}),this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(r.clientWidth,r.clientHeight),this._renderer.setAnimationLoop(this.animate.bind(this)),this._renderer.shadowMap.enabled=!1,r.appendChild(this._renderer.domElement),this._controls=new s(this._camera,this._renderer.domElement);const o=new e.AxesHelper(1e4);this._scene.add(o);window.addEventListener("resize",(()=>{this._camera.aspect=r.clientWidth/r.clientHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(r.clientWidth,r.clientHeight)}),!1)}get scene(){return this._scene}add(t){this._scene.add(t),function(t,n){const s=new e.Box3,r=new e.Vector3,o=new e.Vector3,i=new e.Sphere;let a;s.setFromObject(t),!1===s.isEmpty()?(s.getCenter(r),a=s.getBoundingSphere(i).radius):(r.setFromMatrixPosition(t.matrixWorld),a=.1),o.set(0,0,1),o.applyQuaternion(n._camera.quaternion),o.multiplyScalar(4*a),n._camera.lookAt(r),n._camera.position.copy(r).add(o),n._controls.target.copy(r),n._controls.update()}(t,this)}animate(){this._renderer.render(this._scene,this._camera),this._controls.update()}}class l extends e.EventDispatcher{constructor(){super(),this.coordinatesInput=document.getElementById("coordinates"),this.start=document.querySelector(".dropzone"),this.gltf=document.querySelector(".gltf-viewer"),this.input=document.querySelector(".input-container");const e=document.querySelector("input");e.addEventListener("change",(()=>{r.set("file",e.files[0]);const t=e.files[0].name;this.setState({state:"200",msg:`Loaded file success: ${t}`}),this.start.classList.add("start-hide"),this.gltf.style.display="block",this.input.style.display="block",this.dispatchEvent({type:"beginViewer"})})),document.querySelector(".instance-btn").addEventListener("click",(()=>{r.set("coordinates",this.coordinatesInput.value),this.dispatchEvent({type:"beginInstance"})}))}setState(e){document.querySelector(".state").innerHTML=e.msg,"exported"===e.type&&(this.input.style.display="none")}}new class{constructor(){this.ui=new l,this.ui.addEventListener("beginViewer",(async()=>{this.stage=new d,this.loader=new a,this.exporter=new c,this.loader.loadFile().then((e=>{this.stage.add(e)})).catch((e=>{console.error(e)}))})),this.ui.addEventListener("beginInstance",(()=>{this.stage.scene.traverse((e=>{e.isMesh&&(e.material.wireframe=!0)})),this.loader.loadFile().then((e=>{this.exportGLB(e)})).catch((e=>{console.error(e)}))}))}async exportGLB(t){const n=r.get("coordinates").split(",").filter((e=>""!==e.trim())).map((e=>+e));if(n.length%3!=0)return void console.error("coordinates length is not multiple of 3.");const s=n.length/3;t.traverse((function(t){if(t.isMesh){const r=new e.InstancedMesh(t.geometry,t.material,s),o=t.getWorldScale(new e.Vector3);r.scale.copy(new e.Vector3(1,1,1).divide(o));const i=new e.Matrix4;for(let t=0;t<s;t++){const s=new e.Vector3(n[3*t+0],n[3*t+1],n[3*t+2]);console.error(s);const a=new e.Vector3(1,1,1);a.multiply(o),i.compose(s,new e.Quaternion,a),r.setMatrixAt(t,i)}r.name=t.name;const a=t.parent;t.visible=!1,a.add(r)}})),this.stage.add(t),this.exporter.export(t).then((e=>{console.log("export glb file succ."),this.ui.setState({type:"exported",state:"200",msg:`Exported glb file success: ${e} âœ…`})}))}};
